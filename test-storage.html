<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Storage æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #666;
        }
        button {
            background: #4a90d9;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #357abd;
        }
        .log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Consolas', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .status.info {
            background: #cce5ff;
            color: #004085;
        }
        .test-result {
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .test-result.pass {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }
        .test-result.fail {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
        }
        .test-result.pending {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ§ª Supabase Storage æµ‹è¯•å·¥å…·</h1>
        
        <div class="test-section">
            <h3>æ­¥éª¤ 1: æ£€æŸ¥å­˜å‚¨æ¡¶é…ç½®</h3>
            <button onclick="testStorageBucket()">æµ‹è¯•å­˜å‚¨æ¡¶</button>
            <button onclick="clearLogs()">æ¸…é™¤æ—¥å¿—</button>
            <div id="bucket-test-result"></div>
        </div>
        
        <div class="test-section">
            <h3>æ­¥éª¤ 2: æµ‹è¯•æ–‡ä»¶ä¸Šä¼ </h3>
            <p>é€‰æ‹©ä¸€ä¸ªå°å‹å›¾ç‰‡æ–‡ä»¶ï¼ˆå°äº 500KBï¼‰è¿›è¡Œæµ‹è¯•ï¼š</p>
            <input type="file" id="test-file" accept="image/*">
            <button onclick="testUpload()">ä¸Šä¼ æµ‹è¯•</button>
            <div id="upload-test-result"></div>
        </div>
        
        <div class="test-section">
            <h3>æ­¥éª¤ 3: æµ‹è¯•ç»“æœ</h3>
            <div id="test-results"></div>
        </div>
        
        <div class="test-section">
            <h3>è¯¦ç»†æ—¥å¿—</h3>
            <button onclick="copyLogs()">å¤åˆ¶æ—¥å¿—</button>
            <button onclick="clearLogs()">æ¸…é™¤æ—¥å¿—</button>
            <div class="log" id="console-log">æ—¥å¿—å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>
        </div>
    </div>
    
    <script src="supabase.js"></script>
    <script>
        const logElement = document.getElementById('console-log');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            const logMessage = `[${timestamp}] ${prefix} ${message}\n`;
            
            logElement.textContent += logMessage;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }
        
        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        function addTestResult(containerId, message, passed) {
            const container = document.getElementById(containerId);
            const result = document.createElement('div');
            result.className = `test-result ${passed ? 'pass' : 'fail'}`;
            result.innerHTML = message;
            container.appendChild(result);
        }
        
        function clearLogs() {
            logElement.textContent = 'æ—¥å¿—å·²æ¸…é™¤...\n';
            log('æ—¥å¿—å·²æ¸…é™¤');
        }
        
        function copyLogs() {
            const logs = logElement.textContent;
            navigator.clipboard.writeText(logs).then(() => {
                log('âœ“ æ—¥å¿—å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }).catch(() => {
                log('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶');
            });
        }
        
        // æµ‹è¯•å­˜å‚¨æ¡¶
        async function testStorageBucket() {
            log('========================================');
            log('å¼€å§‹æµ‹è¯• Supabase Storage...');
            log('bucket åç§°: ' + STORAGE_BUCKET);
            log('Supabase URL: ' + SUPABASE_URL);
            
            showStatus('bucket-test-result', 'æµ‹è¯•ä¸­...', 'info');
            document.getElementById('bucket-test-result').innerHTML = '';
            document.getElementById('upload-test-result').innerHTML = '';
            document.getElementById('test-results').innerHTML = '';
            
            try {
                // æµ‹è¯• 1: æ£€æŸ¥ bucket æ˜¯å¦å­˜åœ¨
                log('æµ‹è¯• 1: æ£€æŸ¥ bucket é…ç½®...');
                const testResponse = await fetch(
                    `${SUPABASE_URL}/storage/v1/object/list/${STORAGE_BUCKET}`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'apikey': SUPABASE_ANON_KEY,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ prefix: '', limit: 1 })
                    }
                );
                
                log('å“åº”çŠ¶æ€: ' + testResponse.status + ' ' + testResponse.statusText);
                
                if (testResponse.ok) {
                    log('âœ… å­˜å‚¨æ¡¶è®¿é—®æˆåŠŸï¼');
                    addTestResult('bucket-test-result', '<strong>å­˜å‚¨æ¡¶é…ç½®æ­£ç¡®</strong><br>å¯ä»¥æ­£å¸¸è®¿é—® Storage API', true);
                    
                    // æµ‹è¯• 2: æ£€æŸ¥ bucket æ˜¯å¦ä¸º public
                    log('æµ‹è¯• 2: æ£€æŸ¥ bucket æƒé™...');
                    const bucketsResponse = await fetch(
                        `${SUPABASE_URL}/storage/v1/bucket`,
                        {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                'apikey': SUPABASE_ANON_KEY
                            }
                        }
                    );
                    
                    if (bucketsResponse.ok) {
                        const buckets = await bucketsResponse.json();
                        log('è·å–åˆ° bucket åˆ—è¡¨: ' + JSON.stringify(buckets));
                        
                        // å¦‚æœåˆ—è¡¨ä¸ºç©ºï¼Œå°è¯•ç›´æ¥æŸ¥è¯¢ç‰¹å®š bucket
                        if (!buckets || buckets.length === 0) {
                            log('âš ï¸ bucket åˆ—è¡¨ä¸ºç©ºï¼Œå°è¯•ç›´æ¥æŸ¥è¯¢...');
                            const singleBucketResponse = await fetch(
                                `${SUPABASE_URL}/storage/v1/bucket/${STORAGE_BUCKET}`,
                                {
                                    method: 'GET',
                                    headers: {
                                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                        'apikey': SUPABASE_ANON_KEY
                                    }
                                }
                            );
                            
                            if (singleBucketResponse.ok) {
                                const singleBucket = await singleBucketResponse.json();
                                log('ç›´æ¥æŸ¥è¯¢ç»“æœ: ' + JSON.stringify(singleBucket));
                                log('bucket Public: ' + singleBucket.public);
                                if (singleBucket.public) {
                                    log('âœ… bucket å·²ç»æ˜¯ Publicï¼');
                                    addTestResult('bucket-test-result', '<strong>Public æƒé™å·²å¯ç”¨</strong><br>æ–‡ä»¶å°†å¯ä»¥é€šè¿‡å…¬å¼€é“¾æ¥è®¿é—®', true);
                                } else {
                                    log('âš ï¸ bucket ä¸æ˜¯ Publicï¼Œéœ€è¦åœ¨ Supabase åå°è®¾ç½®');
                                    addTestResult('bucket-test-result', '<strong>è­¦å‘Š: bucket ä¸æ˜¯ Public</strong><br>è¯·åœ¨ Supabase åå°å°† bucket è®¾ç½®ä¸º Public', false);
                                }
                            } else {
                                log('ç›´æ¥æŸ¥è¯¢ä¹Ÿå¤±è´¥ï¼Œä½† API å¯ä»¥åˆ—å‡ºæ–‡ä»¶ï¼Œè¯´æ˜ bucket å­˜åœ¨');
                                log('è·³è¿‡æƒé™æ£€æŸ¥ï¼Œç›´æ¥è¿›è¡Œä¸Šä¼ æµ‹è¯•');
                                addTestResult('bucket-test-result', '<strong>å­˜å‚¨æ¡¶å­˜åœ¨ä¸”å¯è®¿é—®</strong><br>ï¼ˆæƒé™æ£€æŸ¥è·³è¿‡ï¼Œä¸Šä¼ æµ‹è¯•å°†éªŒè¯å…¬å¼€è®¿é—®ï¼‰', true);
                            }
                        } else {
                            const photoBucket = buckets.find(b => b.name === STORAGE_BUCKET);
                            if (photoBucket) {
                                log('bucket Public: ' + photoBucket.public);
                                if (photoBucket.public) {
                                    log('âœ… bucket å·²ç»æ˜¯ Publicï¼');
                                    addTestResult('bucket-test-result', '<strong>Public æƒé™å·²å¯ç”¨</strong><br>æ–‡ä»¶å°†å¯ä»¥é€šè¿‡å…¬å¼€é“¾æ¥è®¿é—®', true);
                                } else {
                                    log('âš ï¸ bucket ä¸æ˜¯ Publicï¼Œéœ€è¦åœ¨ Supabase åå°è®¾ç½®');
                                    addTestResult('bucket-test-result', '<strong>è­¦å‘Š: bucket ä¸æ˜¯ Public</strong><br>è¯·åœ¨ Supabase åå°å°† bucket è®¾ç½®ä¸º Public', false);
                                }
                            } else {
                                log('âŒ æœªæ‰¾åˆ°åä¸º ' + STORAGE_BUCKET + ' çš„ bucket');
                                addTestResult('bucket-test-result', '<strong>é”™è¯¯: æœªæ‰¾åˆ° bucket</strong><br>è¯·ç¡®è®¤ bucket åç§°æ˜¯å¦æ­£ç¡®', false);
                            }
                        }
                    }
                    
                    // æµ‹è¯• 3: å°è¯•åˆ—å‡ºæ–‡ä»¶
                    log('æµ‹è¯• 3: åˆ—å‡º bucket ä¸­çš„æ–‡ä»¶...');
                    const listResponse = await fetch(
                        `${SUPABASE_URL}/storage/v1/object/list/${STORAGE_BUCKET}`,
                        {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                'apikey': SUPABASE_ANON_KEY,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ prefix: '', limit: 10 })
                        }
                    );
                    
                    if (listResponse.ok) {
                        const files = await listResponse.json();
                        log('bucket ä¸­æœ‰ ' + (files.length || 0) + ' ä¸ªæ–‡ä»¶');
                        log('âœ… æˆåŠŸåˆ—å‡ºæ–‡ä»¶ï¼');
                        addTestResult('bucket-test-result', '<strong>API è°ƒç”¨æˆåŠŸ</strong><br>å¯ä»¥æ­£å¸¸åˆ—å‡ºæ–‡ä»¶', true);
                    } else {
                        log('âŒ åˆ—å‡ºæ–‡ä»¶å¤±è´¥: ' + listResponse.status);
                    }
                    
                } else {
                    const errorText = await testResponse.text();
                    log('âŒ å­˜å‚¨æ¡¶è®¿é—®å¤±è´¥: ' + errorText);
                    addTestResult('bucket-test-result', '<strong>å­˜å‚¨æ¡¶è®¿é—®å¤±è´¥</strong><br>é”™è¯¯: ' + testResponse.status + '<br>' + errorText, false);
                    
                    // æä¾›è§£å†³æ–¹æ¡ˆ
                    let solution = '<br><br><strong>å¯èƒ½çš„åŸå› ï¼š</strong>';
                    solution += '<br>1. CORS æœªé…ç½® - éœ€åœ¨ Supabase åå°è®¾ç½® CORS';
                    solution += '<br>2. Bucket åç§°é”™è¯¯ - å½“å‰ä½¿ç”¨: ' + STORAGE_BUCKET;
                    solution += '<br>3. API Key æƒé™é—®é¢˜';
                    solution += '<br><br><strong>è¯·æ£€æŸ¥ï¼š</strong>';
                    solution += '<br>- Supabase åå° â†’ Storage â†’ Settings â†’ CORS';
                    solution += '<br>- ç¡®ä¿å·²åˆ›å»ºåä¸º "' + STORAGE_BUCKET + '" çš„ bucket';
                    solution += '<br>- Bucket å¿…é¡»è®¾ç½®ä¸º Public';
                    addTestResult('bucket-test-result', solution, false);
                }
                
            } catch (error) {
                log('âŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ' + error.message);
                log('é”™è¯¯å †æ ˆ: ' + error.stack);
                addTestResult('bucket-test-result', '<strong>æµ‹è¯•å¤±è´¥</strong><br>' + error.message, false);
            }
            
            log('æµ‹è¯•å®Œæˆ');
            log('========================================');
        }
        
        // æµ‹è¯•ä¸Šä¼ 
        async function testUpload() {
            const fileInput = document.getElementById('test-file');
            const file = fileInput.files[0];
            
            if (!file) {
                log('âŒ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ–‡ä»¶');
                showStatus('upload-test-result', 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ–‡ä»¶', 'error');
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) {
                log('âŒ æ–‡ä»¶å¤ªå¤§ï¼Œä¸èƒ½è¶…è¿‡ 10MB');
                showStatus('upload-test-result', 'æ–‡ä»¶å¤ªå¤§ï¼Œä¸èƒ½è¶…è¿‡ 10MB', 'error');
                return;
            }
            
            log('========================================');
            log('å¼€å§‹ä¸Šä¼ æµ‹è¯•...');
            log('æ–‡ä»¶å: ' + file.name);
            log('æ–‡ä»¶å¤§å°: ' + (file.size / 1024).toFixed(2) + ' KB');
            log('æ–‡ä»¶ç±»å‹: ' + file.type);
            
            showStatus('upload-test-result', 'ä¸Šä¼ ä¸­...', 'info');
            
            try {
                const result = await window.supabase.upload('photos', 'test_' + Date.now() + '_' + file.name, file);
                
                if (result.error) {
                    log('âŒ ä¸Šä¼ å¤±è´¥: ' + result.error.message);
                    addTestResult('upload-test-result', '<strong>ä¸Šä¼ å¤±è´¥</strong><br>' + result.error.message, false);
                } else {
                    log('âœ… ä¸Šä¼ æˆåŠŸï¼');
                    log('æ–‡ä»¶ URL: ' + result.data.path);
                    addTestResult('upload-test-result', '<strong>ä¸Šä¼ æˆåŠŸï¼</strong><br><a href="' + result.data.path + '" target="_blank">ç‚¹å‡»æŸ¥çœ‹æ–‡ä»¶</a>', true);
                }
                
            } catch (error) {
                log('âŒ ä¸Šä¼ å¼‚å¸¸: ' + error.message);
                addTestResult('upload-test-result', '<strong>ä¸Šä¼ å¼‚å¸¸</strong><br>' + error.message, false);
            }
            
            log('ä¸Šä¼ æµ‹è¯•å®Œæˆ');
            log('========================================');
        }
        
        // åˆå§‹åŒ–
        log('ğŸ§ª Supabase Storage æµ‹è¯•å·¥å…·å·²å°±ç»ª');
        log('è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æµ‹è¯•:');
        log('1. ç‚¹å‡»"æµ‹è¯•å­˜å‚¨æ¡¶"æ£€æŸ¥é…ç½®');
        log('2. å¦‚æœæµ‹è¯•é€šè¿‡ï¼Œå°è¯•ä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶');
        log('3. å¦‚æœæœ‰é—®é¢˜ï¼Œè¯·å¤åˆ¶æ—¥å¿—å‘é€ç»™æˆ‘');
    </script>
</body>
</html>
